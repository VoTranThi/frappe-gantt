const t="year",e="month",i="day",s="hour",n="minute",a="second",r="millisecond",o={parse_duration(t){const e=/([0-9]+)(y|m|d|h|min|s|ms)/gm.exec(t);if(null!==e){if("y"===e[2])return{duration:parseInt(e[1]),scale:"year"};if("m"===e[2])return{duration:parseInt(e[1]),scale:"month"};if("d"===e[2])return{duration:parseInt(e[1]),scale:"day"};if("h"===e[2])return{duration:parseInt(e[1]),scale:"hour"};if("min"===e[2])return{duration:parseInt(e[1]),scale:"minute"};if("s"===e[2])return{duration:parseInt(e[1]),scale:"second"};if("ms"===e[2])return{duration:parseInt(e[1]),scale:"millisecond"}}},parse(t,e="-",i=/[.:]/){if(t instanceof Date)return t;if("string"==typeof t){let s,n;const a=t.split(" ");s=a[0].split(e).map((t=>parseInt(t,10))),n=a[1]&&a[1].split(i),s[1]=s[1]?s[1]-1:0;let r=s;return n&&n.length&&(4===n.length&&(n[3]="0."+n[3],n[3]=1e3*parseFloat(n[3])),r=r.concat(n)),new Date(...r)}},to_string(t,e=!1){if(!(t instanceof Date))throw new TypeError("Invalid argument type");const i=this.get_date_values(t).map(((t,e)=>(1===e&&(t+=1),h(t+"",6===e?3:2,"0")))),s=`${i[0]}-${i[1]}-${i[2]}`,n=`${i[3]}:${i[4]}:${i[5]}.${i[6]}`;return s+(e?" "+n:"")},format(t,e="YYYY-MM-DD HH:mm:ss.SSS",i="en"){const s=new Intl.DateTimeFormat(i,{month:"long"}),n=new Intl.DateTimeFormat(i,{month:"short"}),a=s.format(t),r=a.charAt(0).toUpperCase()+a.slice(1),o=this.get_date_values(t).map((t=>h(t,2,0))),d={YYYY:o[0],MM:h(+o[1]+1,2,0),DD:o[2],HH:o[3],mm:o[4],ss:o[5],SSS:o[6],D:o[2],MMMM:r,MMM:n.format(t)};let l=e;const g=[];return Object.keys(d).sort(((t,e)=>e.length-t.length)).forEach((t=>{l.includes(t)&&(l=l.replaceAll(t,`$${g.length}`),g.push(d[t]))})),g.forEach(((t,e)=>{l=l.replaceAll(`$${e}`,t)})),l},diff(t,e,i="day"){let s,n,a,r,o,h,d;s=t-e+6e4*(e.getTimezoneOffset()-t.getTimezoneOffset()),n=s/1e3,r=n/60,a=r/60,o=a/24;let l=t.getFullYear()-e.getFullYear(),g=t.getMonth()-e.getMonth();return g+=o%30/30,h=12*l+g,t.getDate()<e.getDate()&&h--,d=h/12,i.endsWith("s")||(i+="s"),Math.round(100*{milliseconds:s,seconds:n,minutes:r,hours:a,days:o,months:h,years:d}[i])/100},today(){const t=this.get_date_values(new Date).slice(0,3);return new Date(...t)},now:()=>new Date,add(o,h,d){h=parseInt(h,10);const l=[o.getFullYear()+(d===t?h:0),o.getMonth()+(d===e?h:0),o.getDate()+(d===i?h:0),o.getHours()+(d===s?h:0),o.getMinutes()+(d===n?h:0),o.getSeconds()+(d===a?h:0),o.getMilliseconds()+(d===r?h:0)];return new Date(...l)},start_of(o,h){const d={[t]:6,[e]:5,[i]:4,[s]:3,[n]:2,[a]:1,[r]:0};function l(t){return d[t]<=d[h]}const g=[o.getFullYear(),l(t)?0:o.getMonth(),l(e)?1:o.getDate(),l(i)?0:o.getHours(),l(s)?0:o.getMinutes(),l(n)?0:o.getSeconds(),l(a)?0:o.getMilliseconds()];return new Date(...g)},clone(t){return new Date(...this.get_date_values(t))},get_date_values:t=>[t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()],convert_scales(t,e){const i={millisecond:1.1574074074074074e-8,second:11574074074074073e-21,minute:.0006944444444444445,hour:.041666666666666664,day:1,month:30,year:365},{duration:s,scale:n}=this.parse_duration(t);return s*i[n]/i[e]},get_days_in_month(t){const e=t.getMonth();if(1!==e)return[31,28,31,30,31,30,31,31,30,31,30,31][e];const i=t.getFullYear();return i%4==0&&i%100!=0||i%400==0?29:28},get_days_in_year:t=>t.getFullYear()%4?365:366};function h(t,e,i){return t+="",e|=0,i=String(typeof i<"u"?i:" "),t.length>e?String(t):((e-=t.length)>i.length&&(i+=i.repeat(e/i.length)),i.slice(0,e)+String(t))}function d(t,e){return"string"==typeof t?(e||document).querySelector(t):t||null}function l(t,e){const i=document.createElementNS("http://www.w3.org/2000/svg",t);for(let t in e)"append_to"===t?e.append_to.appendChild(i):"innerHTML"===t?i.innerHTML=e.innerHTML:"clipPath"===t?i.setAttribute("clip-path","url(#"+e[t]+")"):i.setAttribute(t,e[t]);return i}function g(t,e,i,s){const n=function(t,e,i,s,n="0.4s",a="0.1s"){const r=t.querySelector("animate");if(r)return d.attr(r,{attributeName:e,from:i,to:s,dur:n,begin:"click + "+a}),t;const o=l("animate",{attributeName:e,from:i,to:s,dur:n,begin:a,calcMode:"spline",values:i+";"+s,keyTimes:"0; 1",keySplines:_("ease-out")});return t.appendChild(o),t}(t,e,i,s);if(n===t){const t=document.createEvent("HTMLEvents");t.initEvent("click",!0,!0),t.eventName="click",n.dispatchEvent(t)}}function _(t){return{ease:".25 .1 .25 1",linear:"0 0 1 1","ease-in":".42 0 1 1","ease-out":"0 0 .58 1","ease-in-out":".42 0 .58 1"}[t]}d.on=(t,e,i,s)=>{s?d.delegate(t,e,i,s):(s=i,d.bind(t,e,s))},d.off=(t,e,i)=>{t.removeEventListener(e,i)},d.bind=(t,e,i)=>{e.split(/\s+/).forEach((function(e){t.addEventListener(e,i)}))},d.delegate=(t,e,i,s)=>{t.addEventListener(e,(function(t){const e=t.target.closest(i);e&&(t.delegatedTarget=e,s.call(this,t,e))}))},d.closest=(t,e)=>e?e.matches(t)?e:d.closest(t,e.parentNode):null,d.attr=(t,e,i)=>{if(!i&&"string"==typeof e)return t.getAttribute(e);if("object"!=typeof e)t.setAttribute(e,i);else for(let i in e)d.attr(t,i,e[i])};class c{constructor(t,e,i){this.gantt=t,this.from_task=e,this.to_task=i,this.calculate_path(),this.draw()}calculate_path(){let t=this.from_task.$bar.getX()+this.from_task.$bar.getWidth()/2;const e=()=>this.to_task.$bar.getX()<t+this.gantt.options.padding&&t>this.from_task.$bar.getX()+this.gantt.options.padding;for(;e();)t-=10;t-=10;let i=this.gantt.config.header_height+this.gantt.options.bar_height+(this.gantt.options.padding+this.gantt.options.bar_height)*this.from_task.task._index+this.gantt.options.padding/2,s=this.to_task.$bar.getX()-13,n=this.gantt.config.header_height+this.gantt.options.bar_height/2+(this.gantt.options.padding+this.gantt.options.bar_height)*this.to_task.task._index+this.gantt.options.padding/2;const a=this.from_task.task._index>this.to_task.task._index;let r=this.gantt.options.arrow_curve;const o=a?1:0;let h=a?-r:r;if(this.to_task.$bar.getX()<=this.from_task.$bar.getX()+this.gantt.options.padding){let e=this.gantt.options.padding/2-r;e<0&&(e=0,r=this.gantt.options.padding/2,h=a?-r:r);const d=this.to_task.$bar.getY()+this.to_task.$bar.getHeight()/2-h,l=this.to_task.$bar.getX()-this.gantt.options.padding;this.path=`\n                M ${t} ${i}\n                v ${e}\n                a ${r} ${r} 0 0 1 ${-r} ${r}\n                H ${l}\n                a ${r} ${r} 0 0 ${o} ${-r} ${h}\n                V ${d}\n                a ${r} ${r} 0 0 ${o} ${r} ${h}\n                L ${s} ${n}\n                m -5 -5\n                l 5 5\n                l -5 5`}else{s<t+r&&(r=s-t);let e=a?n+r:n-r;this.path=`\n              M ${t} ${i}\n              V ${e}\n              a ${r} ${r} 0 0 ${o} ${r} ${r}\n              L ${s} ${n}\n              m -5 -5\n              l 5 5\n              l -5 5`}}draw(){this.element=l("path",{d:this.path,"data-from":this.from_task.task.id,"data-to":this.to_task.task.id})}update(){this.calculate_path(),this.element.setAttribute("d",this.path)}}class p{constructor(t,e){this.set_defaults(t,e),this.prepare_wrappers(),this.prepare_helpers(),this.refresh()}refresh(){this.bar_group.innerHTML="",this.handle_group.innerHTML="",this.task.custom_class?this.group.classList.add(this.task.custom_class):this.group.classList=["bar-wrapper"],this.prepare_values(),this.draw(),this.bind()}set_defaults(t,e){this.action_completed=!1,this.gantt=t,this.task=e,this.name=this.name||""}prepare_wrappers(){this.group=l("g",{class:"bar-wrapper"+(this.task.custom_class?" "+this.task.custom_class:""),"data-id":this.task.id}),this.bar_group=l("g",{class:"bar-group",append_to:this.group}),this.handle_group=l("g",{class:"handle-group",append_to:this.group})}prepare_values(){this.invalid=this.task.invalid,this.height=this.gantt.options.bar_height,this.image_size=this.height-5,this.task._start||(this.task._start=new Date(this.task.start)),this.task._end=new Date(this.task.end),this.task.baseline&&(this.task._baseline_start||(this.task._baseline_start=new Date(this.task.baseline_start)),this.task._baseline_end=new Date(this.task.baseline_end)),this.compute_x(),this.compute_y(),this.compute_duration(),this.compute_baseline_duration(),this.corner_radius=this.gantt.options.bar_corner_radius,this.width=this.gantt.config.column_width*this.duration,(!this.task.progress||this.task.progress<0)&&(this.task.progress=0),this.task.progress>100&&(this.task.progress=100),this.task.baseline&&(this.baseline_width=this.gantt.config.column_width*this.baseline_duration,this.task.baseline_progress||(this.task.baseline_progress=0),this.task.baseline_progress=Math.max(Math.min(this.task.baseline_progress,100),0))}prepare_helpers(){SVGElement.prototype.getX=function(){return+this.getAttribute("x")},SVGElement.prototype.getY=function(){return+this.getAttribute("y")},SVGElement.prototype.getWidth=function(){return+this.getAttribute("width")},SVGElement.prototype.getHeight=function(){return+this.getAttribute("height")},SVGElement.prototype.getEndX=function(){return this.getX()+this.getWidth()}}prepare_expected_progress_values(){this.compute_expected_progress(),this.expected_progress_width=this.gantt.options.column_width*this.duration*(this.expected_progress/100)||0}draw(){this.draw_bar(),this.draw_progress_bar(),this.gantt.options.show_expected_progress&&(this.prepare_expected_progress_values(),this.draw_expected_progress_bar()),this.draw_label(),this.draw_resize_handles(),this.task.thumbnail&&this.draw_thumbnail(),this.gantt.options.show_baseline&&this.draw_baselinebar()}draw_bar(){this.$bar=l("rect",{x:this.x,y:this.y,width:this.width,height:this.height,rx:this.corner_radius,ry:this.corner_radius,class:"bar",append_to:this.bar_group}),this.task.color&&(this.$bar.style.fill=this.task.color),g(this.$bar,"width",0,this.width),this.invalid&&this.$bar.classList.add("bar-invalid")}draw_baselinebar(){this.task.baseline&&(this.$bar_baseline=l("rect",{x:this.baseline_x,y:this.baseline_y,width:this.baseline_width,height:10,rx:this.corner_radius,ry:this.corner_radius,class:"bar baseline",append_to:this.bar_group}),this.task.baseline_color?this.$bar_baseline.style.fill=this.task.baseline_color:this.$bar_baseline.style.fill="#b686ea",g(this.$bar_baseline,"width",0,this.baseline_width))}draw_expected_progress_bar(){this.invalid||(this.$expected_bar_progress=l("rect",{x:this.x,y:this.y,width:this.expected_progress_width,height:this.height,rx:this.corner_radius,ry:this.corner_radius,class:"bar-expected-progress",append_to:this.bar_group}),g(this.$expected_bar_progress,"width",0,this.expected_progress_width))}draw_progress_bar(){if(this.invalid)return;this.progress_width=this.calculate_progress_width();let t=this.corner_radius;/^((?!chrome|android).)*safari/i.test(navigator.userAgent)||(t=this.corner_radius+2),this.$bar_progress=l("rect",{x:this.x,y:this.y,width:this.progress_width,height:this.height,rx:t,ry:t,class:"bar-progress",append_to:this.bar_group}),this.task.color_progress&&(this.$bar_progress.style.fill=this.task.color);const e=o.diff(this.task._start,this.gantt.gantt_start,this.gantt.config.unit)/this.gantt.config.step*this.gantt.config.column_width;let i=this.gantt.create_el({classes:`date-range-highlight hide highlight-${this.task.id}`,width:this.width,left:e});this.$date_highlight=i,this.gantt.$lower_header.prepend(this.$date_highlight),g(this.$bar_progress,"width",0,this.progress_width)}calculate_progress_width(){const t=this.$bar.getWidth(),e=this.x+t;let i=(t-this.gantt.config.ignored_positions.reduce(((t,i)=>t+(i>=this.x&&i<e)),0)*this.gantt.config.column_width)*this.task.progress/100;const s=this.x+i;i+=this.gantt.config.ignored_positions.reduce(((t,e)=>t+(e>=this.x&&e<s)),0)*this.gantt.config.column_width;let n=this.gantt.get_ignored_region(this.x+i);for(;n.length;)i+=this.gantt.config.column_width,n=this.gantt.get_ignored_region(this.x+i);return this.progress_width=i,i}draw_label(){let t=this.x+this.$bar.getWidth()/2;this.task.thumbnail&&(t=this.x+this.image_size+5),l("text",{x:t,y:this.y+this.height/2,innerHTML:this.task.name,class:"bar-label",append_to:this.bar_group}),requestAnimationFrame((()=>this.update_label_position()))}draw_thumbnail(){let t,e;t=l("defs",{append_to:this.bar_group}),l("rect",{id:"rect_"+this.task.id,x:this.x+10,y:this.y+2,width:this.image_size,height:this.image_size,rx:"15",class:"img_mask",append_to:t}),e=l("clipPath",{id:"clip_"+this.task.id,append_to:t}),l("use",{href:"#rect_"+this.task.id,append_to:e}),l("image",{x:this.x+10,y:this.y+2,width:this.image_size,height:this.image_size,class:"bar-img",href:this.task.thumbnail,clipPath:"clip_"+this.task.id,append_to:this.bar_group})}draw_resize_handles(){if(this.invalid||this.gantt.options.readonly)return;const t=this.$bar;if(this.handles=[],this.gantt.options.readonly_dates||(this.handles.push(l("rect",{x:t.getEndX()-1.5,y:t.getY()+this.height/4,width:3,height:this.height/2,rx:2,ry:2,class:"handle right",append_to:this.handle_group})),this.handles.push(l("rect",{x:t.getX()-1.5,y:t.getY()+this.height/4,width:3,height:this.height/2,rx:2,ry:2,class:"handle left",append_to:this.handle_group}))),!this.gantt.options.readonly_progress){const t=this.$bar_progress;this.$handle_progress=l("circle",{cx:t.getEndX(),cy:t.getY()+t.getHeight()/2,r:4.5,class:"handle progress",append_to:this.handle_group}),this.handles.push(this.$handle_progress)}for(let t of this.handles)d.on(t,"mouseenter",(()=>t.classList.add("active"))),d.on(t,"mouseleave",(()=>t.classList.remove("active")))}bind(){this.invalid||this.setup_click_event()}setup_click_event(){let t,e=this.task.id;d.on(this.group,"mouseover",(t=>{this.gantt.trigger_event("hover",[this.task,t.screenX,t.screenY,t])})),"click"===this.gantt.options.popup_on&&d.on(this.group,"mouseup",(t=>{const e=t.offsetX||t.layerX;if(this.$handle_progress){const t=+this.$handle_progress.getAttribute("cx");if(t>e-1&&t<e+1||this.gantt.bar_being_dragged)return}this.gantt.show_popup({x:t.offsetX||t.layerX,y:t.offsetY||t.layerY,task:this.task,target:this.$bar})})),d.on(this.group,"mouseenter",(i=>{t=setTimeout((()=>{"hover"===this.gantt.options.popup_on&&this.gantt.show_popup({x:i.offsetX||i.layerX,y:i.offsetY||i.layerY,task:this.task,target:this.$bar}),this.gantt.$container.querySelector(`.highlight-${e}`).classList.remove("hide")}),200)})),d.on(this.group,"mouseleave",(()=>{var i,s;clearTimeout(t),"hover"===this.gantt.options.popup_on&&(null==(s=null==(i=this.gantt.popup)?void 0:i.hide)||s.call(i)),this.gantt.$container.querySelector(`.highlight-${e}`).classList.add("hide")})),d.on(this.group,"click",(()=>{this.gantt.trigger_event("click",[this.task])})),d.on(this.group,"dblclick",(t=>{this.action_completed||(this.group.classList.remove("active"),this.gantt.popup&&this.gantt.popup.parent.classList.remove("hide"),this.gantt.trigger_event("double_click",[this.task]))}))}update_bar_position({x:t=null,width:e=null}){const i=this.$bar;if(t){if(!this.task.dependencies.map((t=>this.gantt.get_bar(t).$bar.getX())).reduce(((e,i)=>e&&t>=i),!0))return;this.update_attr(i,"x",t),this.x=t,this.$date_highlight.style.left=t+"px"}e>0&&(this.update_attr(i,"width",e),this.$date_highlight.style.width=e+"px"),this.update_label_position(),this.update_handle_position(),this.date_changed(),this.compute_duration(),this.gantt.options.show_baseline&&this.compute_baseline_duration(),this.gantt.options.show_expected_progress&&this.update_expected_progressbar_position(),this.update_progressbar_position(),this.update_arrow_position()}update_label_position_on_horizontal_scroll({x:t,sx:e}){const i=this.gantt.$container.querySelector(".gantt-container"),s=this.group.querySelector(".bar-label"),n=this.group.querySelector(".bar-img")||"",a=this.bar_group.querySelector(".img_mask")||"";let r=this.$bar.getX()+this.$bar.getWidth(),o=s.getX()+t,h=n&&n.getX()+t||0,d=n&&n.getBBox().width+7||7,l=o+s.getBBox().width+7,g=e+i.clientWidth/2;s.classList.contains("big")||(l<r&&t>0&&l<g||o-d>this.$bar.getX()&&t<0&&l>g)&&(s.setAttribute("x",o),n&&(n.setAttribute("x",h),a.setAttribute("x",h)))}date_changed(){let t=!1;const{new_start_date:e,new_end_date:i}=this.compute_start_end_date();Number(this.task._start)!==Number(e)&&(t=!0,this.task._start=e),Number(this.task._end)!==Number(i)&&(t=!0,this.task._end=i),t&&this.gantt.trigger_event("date_change",[this.task,e,o.add(i,-1,"second")])}progress_changed(){this.task.progress=this.compute_progress(),this.gantt.trigger_event("progress_change",[this.task,this.task.progress])}set_action_completed(){this.action_completed=!0,setTimeout((()=>this.action_completed=!1),1e3)}compute_start_end_date(){const t=this.$bar,e=t.getX()/this.gantt.config.column_width;let i=o.add(this.gantt.gantt_start,e*this.gantt.config.step,this.gantt.config.unit);const s=t.getWidth()/this.gantt.config.column_width;return{new_start_date:i,new_end_date:o.add(i,s*this.gantt.config.step,this.gantt.config.unit)}}compute_progress(){this.progress_width=this.$bar_progress.getWidth(),this.x=this.$bar_progress.getBBox().x;const t=this.x+this.progress_width,e=this.progress_width-this.gantt.config.ignored_positions.reduce(((e,i)=>e+(i>=this.x&&i<=t)),0)*this.gantt.config.column_width;if(e<0)return 0;const i=this.$bar.getWidth()-this.ignored_duration_raw*this.gantt.config.column_width;return parseInt(e/i*100,10)}compute_expected_progress(){this.expected_progress=o.diff(o.today(),this.task._start,"hour")/this.gantt.config.step,this.expected_progress=100*(this.expected_progress<this.duration?this.expected_progress:this.duration)/this.duration}compute_x(){const{column_width:t}=this.gantt.config,e=this.task._start,i=this.gantt.gantt_start;let s=o.diff(e,i,this.gantt.config.unit)/this.gantt.config.step*t;if(this.x=s,this.task.baseline){const e=this.task._baseline_start,s=o.diff(e,i,this.gantt.config.unit)/this.gantt.config.step;this.baseline_x=s*t}}compute_y(){this.y=this.gantt.config.header_height+this.gantt.options.padding/2+this.task._index*(this.height+this.gantt.options.padding),this.task.baseline&&this.gantt.options.show_baseline&&(this.baseline_y=this.gantt.config.header_height+this.gantt.options.padding/2+this.task._index*(this.height+this.gantt.options.padding),this.baseline_y=this.baseline_y+this.height-4)}compute_duration(){let t=0,e=0;for(let i=new Date(this.task._start);i<this.task._end;i.setDate(i.getDate()+1))e++,!this.gantt.config.ignored_dates.find((t=>t.getTime()===i.getTime()))&&(!this.gantt.config.ignored_function||!this.gantt.config.ignored_function(i))&&t++;this.task.actual_duration=t,this.task.ignored_duration=e-t,this.duration=o.convert_scales(e+"d",this.gantt.config.unit)/this.gantt.config.step,this.actual_duration_raw=o.convert_scales(t+"d",this.gantt.config.unit)/this.gantt.config.step,this.ignored_duration_raw=this.duration-this.actual_duration_raw}compute_baseline_duration(){if(!this.task.baseline||!this.gantt.options.show_baseline)return;let t=0,e=0;for(let i=new Date(this.task._baseline_start);i<this.task._baseline_end;i.setDate(i.getDate()+1))e++,!this.gantt.config.ignored_dates.find((t=>t.getTime()===i.getTime()))&&(!this.gantt.config.ignored_function||!this.gantt.config.ignored_function(i))&&t++;this.task.actual_baseline_duration=t,this.task.ignored_baseline_duration=e-t,this.baseline_duration=o.convert_scales(e+"d",this.gantt.config.unit)/this.gantt.config.step,this.actual_baseline_duration_raw=o.convert_scales(t+"d",this.gantt.config.unit)/this.gantt.config.step,this.ignored_baseline_duration_raw=this.baseline_duration-this.actual_baseline_duration_raw}update_attr(t,e,i){return i=+i,isNaN(i)||t.setAttribute(e,i),t}update_expected_progressbar_position(){this.invalid||(this.$expected_bar_progress.setAttribute("x",this.$bar.getX()),this.compute_expected_progress(),this.$expected_bar_progress.setAttribute("width",this.gantt.config.column_width*this.actual_duration_raw*(this.expected_progress/100)||0))}update_progressbar_position(){this.invalid||this.gantt.options.readonly||(this.$bar_progress.setAttribute("x",this.$bar.getX()),this.$bar_progress.setAttribute("width",this.calculate_progress_width()))}update_label_position(){const t=this.bar_group.querySelector(".img_mask")||"",e=this.$bar,i=this.group.querySelector(".bar-label"),s=this.group.querySelector(".bar-img");let n=this.image_size+10;const a=i.getBBox().width,r=e.getWidth();a>r?(i.classList.add("big"),s?(s.setAttribute("x",e.getEndX()+5),t.setAttribute("x",e.getEndX()+5),i.setAttribute("x",e.getEndX()+n)):i.setAttribute("x",e.getEndX()+5)):(i.classList.remove("big"),s?(s.setAttribute("x",e.getX()+5),t.setAttribute("x",e.getX()+5),i.setAttribute("x",e.getX()+r/2+n)):i.setAttribute("x",e.getX()+r/2-a/2))}update_handle_position(){if(this.invalid||this.gantt.options.readonly)return;const t=this.$bar;this.handle_group.querySelector(".handle.left").setAttribute("x",t.getX()),this.handle_group.querySelector(".handle.right").setAttribute("x",t.getEndX());const e=this.group.querySelector(".handle.progress");e&&e.setAttribute("cx",this.$bar_progress.getEndX())}update_arrow_position(){this.arrows=this.arrows||[];for(let t of this.arrows)t.update()}}class u{constructor(t,e,i){this.parent=t,this.popup_func=e,this.gantt=i,this.make()}make(){this.parent.innerHTML='\n            <div class="title"></div>\n            <div class="subtitle"></div>\n            <div class="details"></div>\n            <div class="actions"></div>\n        ',this.hide(),this.title=this.parent.querySelector(".title"),this.subtitle=this.parent.querySelector(".subtitle"),this.details=this.parent.querySelector(".details"),this.actions=this.parent.querySelector(".actions")}show({x:t,y:e,task:i,target:s}){this.actions.innerHTML="";let n=this.popup_func({task:i,chart:this.gantt,get_title:()=>this.title,set_title:t=>this.title.innerHTML=t,get_subtitle:()=>this.subtitle,set_subtitle:t=>this.subtitle.innerHTML=t,get_details:()=>this.details,set_details:t=>this.details.innerHTML=t,add_action:(t,e)=>{let s=this.gantt.create_el({classes:"action-btn",type:"button",append_to:this.actions});"function"==typeof t&&(t=t(i)),s.innerHTML=t,s.onclick=t=>e(i,this.gantt,t)}});!1!==n&&(n&&(this.parent.innerHTML=n),""===this.actions.innerHTML?this.actions.remove():this.parent.appendChild(this.actions),this.parent.style.left=t+10+"px",this.parent.style.top=e-10+"px",this.parent.classList.remove("hide"))}hide(){this.parent.classList.add("hide")}}function f(t){const e=t.getFullYear();return e-e%10+""}const m=[{name:"Day",padding:"7d",date_format:"YYYY-MM-DD",step:"1d",lower_text:(t,e,i)=>e&&t.getDate()===e.getDate()?"":o.format(t,"D",i),upper_text:(t,e,i)=>e&&t.getMonth()===e.getMonth()?"":o.format(t,"MMMM",i),thick_line:t=>1===t.getDay()},{name:"Week",padding:"1m",step:"7d",date_format:"YYYY-MM-DD",column_width:140,lower_text:function(t,e,i){let s=o.add(t,6,"day"),n=s.getMonth()!==t.getMonth()?"D MMM":"D",a=e&&t.getMonth()===e.getMonth()?"D":"D MMM";return`${o.format(t,a,i)} - ${o.format(s,n,i)}`},upper_text:(t,e,i)=>e&&t.getMonth()===e.getMonth()?"":o.format(t,"MMMM",i),thick_line:t=>t.getDate()>=1&&t.getDate()<=7,upper_text_frequency:4},{name:"Month",padding:"2m",step:"1m",column_width:120,date_format:"YYYY-MM",lower_text:"MMMM",upper_text:(t,e,i)=>e&&t.getFullYear()===e.getFullYear()?"":o.format(t,"YYYY",i),thick_line:t=>t.getMonth()%3==0,snap_at:"7d"},{name:"Year",padding:"2y",step:"1y",column_width:120,date_format:"YYYY",upper_text:(t,e,i)=>e&&f(t)===f(e)?"":f(t),lower_text:"YYYY",snap_at:"30d"}],b={arrow_curve:5,auto_move_label:!1,bar_corner_radius:3,bar_height:30,container_height:"auto",column_width:null,date_format:"YYYY-MM-DD HH:mm",upper_header_height:45,lower_header_height:30,snap_at:null,infinite_padding:!0,holidays:{"var(--g-weekend-highlight-color)":"weekend"},ignore:[],language:"en",lines:"both",move_dependencies:!0,padding:18,popup:t=>{t.set_title(t.task.name),t.task.description?t.set_subtitle(t.task.description):t.set_subtitle("");const e=o.format(t.task._start,"MMM D",t.chart.options.language),i=o.format(o.add(t.task._end,-1,"second"),"MMM D",t.chart.options.language);t.set_details(`${e} - ${i} (${t.task.actual_duration} days${t.task.ignored_duration?" + "+t.task.ignored_duration+" excluded":""})<br/>Progress: ${Math.floor(100*t.task.progress)/100}%`)},popup_on:"click",readonly_progress:!1,readonly_dates:!1,readonly:!1,scroll_to:"today",show_expected_progress:!1,today_button:!0,view_mode:"Day",view_mode_select:!1,view_modes:m};class w{constructor(t,e,i){this.setup_wrapper(t),this.setup_options(i),this.setup_tasks(e),this.change_view_mode(),this.bind_events()}setup_wrapper(t){let e,i;if("string"==typeof t){let e=document.querySelector(t);if(!e)throw new ReferenceError(`CSS selector "${t}" could not be found in DOM`);t=e}if(t instanceof HTMLElement)i=t,e=t.querySelector("svg");else{if(!(t instanceof SVGElement))throw new TypeError("Frappe Gantt only supports usage of a string CSS selector, HTML DOM element or SVG DOM element for the 'element' parameter");e=t}e?(this.$svg=e,this.$svg.classList.add("gantt")):this.$svg=l("svg",{append_to:i,class:"gantt"}),this.$container=this.create_el({classes:"gantt-container",append_to:this.$svg.parentElement}),this.$container.appendChild(this.$svg),this.$popup_wrapper=this.create_el({classes:"popup-wrapper",append_to:this.$container})}setup_options(t){this.original_options=t,this.options={...b,...t};const e={"grid-height":"container_height","bar-height":"bar_height","lower-header-height":"lower_header_height","upper-header-height":"upper_header_height"};for(let t in e){let i=this.options[e[t]];"auto"!==i&&this.$container.style.setProperty("--gv-"+t,i+"px")}if(this.options.height&&this.$container.style.setProperty("height",this.options.height),this.config={ignored_dates:[],ignored_positions:[],extend_by_units:10},"function"!=typeof this.options.ignore){"string"==typeof this.options.ignore&&(this.options.ignore=[this.options.ignord]);for(let t of this.options.ignore)"function"!=typeof t?"string"==typeof t&&("weekend"===t?this.config.ignored_function=t=>6==t.getDay()||0==t.getDay():this.config.ignored_dates.push(new Date(t+" "))):this.config.ignored_function=t}else this.config.ignored_function=this.options.ignore}update_options(t){this.setup_options({...this.original_options,...t}),this.change_view_mode(void 0,!0)}setup_tasks(t){this.tasks=t.map(((t,e)=>{if(!t.start)return console.error(`task "${t.id}" doesn't have a start date`),!1;if(t._start=o.parse(t.start),void 0===t.end&&void 0!==t.duration&&(t.end=t._start,t.duration.split(" ").forEach((e=>{let{duration:i,scale:s}=o.parse_duration(e);t.end=o.add(t.end,i,s)}))),!t.end)return console.error(`task "${t.id}" doesn't have an end date`),!1;if(t._end=o.parse(t.end),o.diff(t._end,t._start,"year")<0)return console.error(`start of task can't be after end of task: in task "${t.id}"`),!1;if(o.diff(t._end,t._start,"year")>10)return console.error(`the duration of task "${t.id}" is too long (above ten years)`),!1;if(t._index=e,o.get_date_values(t._end).slice(3).every((t=>0===t))&&(t._end=o.add(t._end,24,"hour")),"string"==typeof t.dependencies||!t.dependencies){let e=[];t.dependencies&&(e=t.dependencies.split(",").map((t=>t.trim().replaceAll(" ","_"))).filter((t=>t))),t.dependencies=e}if(t.id?"string"==typeof t.id?t.id=t.id.replaceAll(" ","_"):t.id=`${t.id}`:t.id=t.name+"_"+Math.random().toString(36).slice(2,12),t.baseline&&this.options.show_baseline){if(!t.baseline_start)return console.error(`task "${t.id}" doesn't have a baseline start date`),!1;if(t._baseline_start=o.parse(t.baseline_start),void 0===t.baseline_end&&void 0!==t.baseline_duration&&(t.baseline_end=t._baseline_start,t.baseline_duration.split(" ").forEach((e=>{let{duration:i,scale:s}=o.parse_duration(e);t.baseline_end=o.add(t.baseline_end,i,s)}))),!t.baseline_end)return console.error(`task "${t.id}" doesn't have an baseline end date`),!1;if(t._baseline_end=o.parse(t.baseline_end),o.diff(t._baseline_end,t._baseline_start,"year")<0)return console.error(`Baseline start of task can't be after end of task: in task "${t.id}"`),!1;if(o.diff(t._baseline_end,t._baseline_start,"year")>10)return console.error(`the duration baseline of  task "${t.id}" is too long (above ten years)`),!1;o.get_date_values(t._baseline_end).slice(3).every((t=>0===t))&&(t._baseline_end=o.add(t._baseline_end,24,"hour"))}return t})).filter((t=>t)),this.setup_dependencies()}setup_dependencies(){this.dependency_map={};for(let t of this.tasks)for(let e of t.dependencies)this.dependency_map[e]=this.dependency_map[e]||[],this.dependency_map[e].push(t.id)}refresh(t){this.setup_tasks(t),this.change_view_mode()}update_task(t,e){let i=this.tasks.find((e=>e.id===t)),s=this.bars[i._index];Object.assign(i,e),s.refresh()}change_view_mode(t=this.options.view_mode,e=!1){let i,s;"string"==typeof t&&(t=this.options.view_modes.find((e=>e.name===t))),e&&(i=this.$container.scrollLeft,s=this.options.scroll_to,this.options.scroll_to=null),this.options.view_mode=t.name,this.config.view_mode=t,this.update_view_scale(t),this.setup_dates(e),this.render(),e&&(this.$container.scrollLeft=i,this.options.scroll_to=s),this.trigger_event("view_change",[t]),this.options.height&&this.$container.style.setProperty("height",this.options.height)}update_view_scale(t){let{duration:e,scale:i}=o.parse_duration(t.step);this.config.step=e,this.config.unit=i,this.config.column_width=this.options.column_width||t.column_width||45,this.$container.style.setProperty("--gv-column-width",this.config.column_width+"px"),this.config.header_height=this.options.lower_header_height+this.options.upper_header_height+10}setup_dates(t=!1){this.setup_gantt_dates(t),this.setup_date_values()}setup_gantt_dates(t){let e,i;this.tasks.length||(e=new Date,i=new Date);for(let t of this.tasks)(!e||t._start<e)&&(e=t._start),(!i||t._end>i)&&(i=t._end);if(e=o.start_of(e,this.config.unit),i=o.start_of(i,this.config.unit),!t)if(this.options.infinite_padding)this.gantt_start=o.add(e,3*-this.config.extend_by_units,this.config.unit),this.gantt_end=o.add(i,3*this.config.extend_by_units,this.config.unit);else{"string"==typeof this.config.view_mode.padding&&(this.config.view_mode.padding=[this.config.view_mode.padding,this.config.view_mode.padding]);let[t,s]=this.config.view_mode.padding.map(o.parse_duration);this.gantt_start=o.add(e,-t.duration,t.scale),this.gantt_end=o.add(i,s.duration,s.scale)}this.config.date_format=this.config.view_mode.date_format||this.options.date_format,this.gantt_start.setHours(0,0,0,0)}setup_date_values(){let t=this.gantt_start;for(this.dates=[t];t<this.gantt_end;)t=o.add(t,this.config.step,this.config.unit),this.dates.push(t)}bind_events(){this.bind_grid_click(),this.bind_holiday_labels(),this.bind_bar_events()}render(){this.clear(),this.setup_layers(),this.make_grid(),this.make_dates(),this.make_grid_extras(),this.make_bars(),this.make_arrows(),this.map_arrows_on_bars(),this.set_dimensions(),this.set_scroll_position(this.options.scroll_to)}setup_layers(){this.layers={};const t=["grid","arrow","progress","bar"];for(let e of t)this.layers[e]=l("g",{class:e,append_to:this.$svg});this.$extras=this.create_el({classes:"extras",append_to:this.$container}),this.$adjust=this.create_el({classes:"adjust hide",append_to:this.$extras,type:"button"}),this.$adjust.innerHTML="&larr;"}make_grid(){this.make_grid_background(),this.make_grid_rows(),this.make_grid_header(),this.make_side_header()}make_grid_extras(){this.make_grid_highlights(),this.make_grid_ticks()}make_grid_background(){const t=this.dates.length*this.config.column_width,e=Math.max(this.config.header_height+this.options.padding+(this.options.bar_height+this.options.padding)*this.tasks.length-10,"auto"!==this.options.container_height?this.options.container_height:0);l("rect",{x:0,y:0,width:t,height:e,class:"grid-background",append_to:this.$svg}),d.attr(this.$svg,{height:e,width:"100%"}),this.grid_height=e,"auto"===this.options.container_height&&(this.$container.style.height=e+"px")}make_grid_rows(){const t=l("g",{append_to:this.layers.grid}),e=this.dates.length*this.config.column_width,i=this.options.bar_height+this.options.padding;this.config.header_height;for(let s=this.config.header_height;s<this.grid_height;s+=i)l("rect",{x:0,y:s,width:e,height:i,class:"grid-row",append_to:t})}make_grid_header(){this.$header=this.create_el({width:this.dates.length*this.config.column_width,classes:"grid-header",append_to:this.$container}),this.$upper_header=this.create_el({classes:"upper-header",append_to:this.$header}),this.$lower_header=this.create_el({classes:"lower-header",append_to:this.$header})}make_side_header(){if(this.$side_header=this.create_el({classes:"side-header"}),this.$upper_header.prepend(this.$side_header),this.options.view_mode_select){const t=document.createElement("select");t.classList.add("viewmode-select");const e=document.createElement("option");e.selected=!0,e.disabled=!0,e.textContent="Mode",t.appendChild(e);for(const e of this.options.view_modes){const i=document.createElement("option");i.value=e.name,i.textContent=e.name,e.name===this.config.view_mode.name&&(i.selected=!0),t.appendChild(i)}t.addEventListener("change",function(){this.change_view_mode(t.value,!0)}.bind(this)),this.$side_header.appendChild(t)}if(this.options.today_button){let t=document.createElement("button");t.classList.add("today-button"),t.textContent="Today",t.onclick=this.scroll_current.bind(this),this.$side_header.prepend(t),this.$today_button=t}}make_grid_ticks(){if("none"===this.options.lines)return;let t=0,e=this.config.header_height,i=this.grid_height-this.config.header_height,s=l("g",{class:"lines_layer",append_to:this.layers.grid}),n=this.config.header_height;const a=this.dates.length*this.config.column_width,r=this.options.bar_height+this.options.padding;if("vertical"!==this.options.lines)for(let t=this.config.header_height;t<this.grid_height;t+=r)l("line",{x1:0,y1:n+r,x2:a,y2:n+r,class:"row-line",append_to:s}),n+=r;if("horizontal"!==this.options.lines)for(let s of this.dates){let n="tick";this.config.view_mode.thick_line&&this.config.view_mode.thick_line(s)&&(n+=" thick"),l("path",{d:`M ${t} ${e} v ${i}`,class:n,append_to:this.layers.grid}),this.view_is("month")?t+=o.get_days_in_month(s)*this.config.column_width/30:this.view_is("year")?t+=o.get_days_in_year(s)*this.config.column_width/365:t+=this.config.column_width}}highlight_holidays(){let t={};if(this.options.holidays)for(let e in this.options.holidays){let i,s=this.options.holidays[e];if("weekend"===s&&(s=t=>0===t.getDay()||6===t.getDay()),"object"==typeof s){let n=s.find((t=>"function"==typeof t));if(n&&(i=n),this.options.holidays.name){let e=new Date(s.date+" ");s=t=>e.getTime()===t.getTime(),t[e]=s.name}else s=i=>this.options.holidays[e].filter((t=>"function"!=typeof t)).map((e=>{if(e.name){let i=new Date(e.date+" ");return t[i]=e.name,i.getTime()}return new Date(e+" ").getTime()})).includes(i.getTime())}for(let n=new Date(this.gantt_start);n<=this.gantt_end;n.setDate(n.getDate()+1))if(!(this.config.ignored_dates.find((t=>t.getTime()==n.getTime()))||this.config.ignored_function&&this.config.ignored_function(n))&&(s(n)||i&&i(n))){const i=o.diff(n,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width,s=this.grid_height-this.config.header_height,a=o.format(n,"YYYY-MM-DD",this.options.language).replace(" ","_");if(t[n]){this.create_el({classes:"holiday-label label_"+a,append_to:this.$extras}).textContent=t[n]}l("rect",{x:Math.round(i),y:this.config.header_height,width:this.config.column_width/o.convert_scales(this.config.view_mode.step,"day"),height:s,class:"holiday-highlight "+a,style:`fill: ${e};`,append_to:this.layers.grid})}}}highlight_current(){const t=this.get_closest_date();if(!t)return;const[e,i]=t;i.classList.add("current-date-highlight");const s=o.diff(new Date,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width;this.$current_highlight=this.create_el({top:this.config.header_height,left:s,height:this.grid_height-this.config.header_height,classes:"current-highlight",append_to:this.$container}),this.$current_ball_highlight=this.create_el({top:this.config.header_height-6,left:s-2.5,width:6,height:6,classes:"current-ball-highlight",append_to:this.$header})}make_grid_highlights(){this.highlight_holidays(),this.config.ignored_positions=[];const t=(this.options.bar_height+this.options.padding)*this.tasks.length;this.layers.grid.innerHTML+='<pattern id="diagonalHatch" patternUnits="userSpaceOnUse" width="4" height="4">\n          <path d="M-1,1 l2,-2\n                   M0,4 l4,-4\n                   M3,5 l2,-2"\n                style="stroke:grey; stroke-width:0.3" />\n        </pattern>';for(let e=new Date(this.gantt_start);e<=this.gantt_end;e.setDate(e.getDate()+1)){if(!(this.config.ignored_dates.find((t=>t.getTime()==e.getTime()))||this.config.ignored_function&&this.config.ignored_function(e)))continue;let i=o.convert_scales(o.diff(e,this.gantt_start)+"d",this.config.unit)/this.config.step;this.config.ignored_positions.push(i*this.config.column_width),l("rect",{x:i*this.config.column_width,y:this.config.header_height,width:this.config.column_width,height:t,class:"ignored-bar",style:"fill: url(#diagonalHatch);",append_to:this.$svg})}this.highlight_current(this.config.view_mode)}create_el({left:t,top:e,width:i,height:s,id:n,classes:a,append_to:r,type:o}){let h=document.createElement(o||"div");for(let t of a.split(" "))h.classList.add(t);return h.style.top=e+"px",h.style.left=t+"px",n&&(h.id=n),i&&(h.style.width=i+"px"),s&&(h.style.height=s+"px"),r&&r.appendChild(h),h}make_dates(){this.get_dates_to_draw().forEach(((t,e)=>{if(t.lower_text){this.create_el({left:t.x,top:t.lower_y,classes:"lower-text date_"+y(t.formatted_date),append_to:this.$lower_header}).innerText=t.lower_text}if(t.upper_text){this.create_el({left:t.x,top:t.upper_y,classes:"upper-text",append_to:this.$upper_header}).innerText=t.upper_text}})),this.upperTexts=Array.from(this.$container.querySelectorAll(".upper-text"))}get_dates_to_draw(){let t=null;return this.dates.map(((e,i)=>{const s=this.get_date_info(e,t,i);return t=s,s}))}get_date_info(t,e){let i=e?e.date:null;this.config.column_width;const s=e?e.x+e.column_width:0;let n=this.config.view_mode.upper_text,a=this.config.view_mode.lower_text;return n?"string"==typeof n&&(this.config.view_mode.upper_text=t=>o.format(t,n,this.options.language)):this.config.view_mode.upper_text=()=>"",a?"string"==typeof a&&(this.config.view_mode.lower_text=t=>o.format(t,a,this.options.language)):this.config.view_mode.lower_text=()=>"",{date:t,formatted_date:y(o.format(t,this.config.date_format,this.options.language)),column_width:this.config.column_width,x:s,upper_text:this.config.view_mode.upper_text(t,i,this.options.language),lower_text:this.config.view_mode.lower_text(t,i,this.options.language),upper_y:17,lower_y:this.options.upper_header_height+5}}make_bars(){this.bars=this.tasks.map((t=>{const e=new p(this,t);return this.layers.bar.appendChild(e.group),e}))}make_arrows(){this.arrows=[];for(let t of this.tasks){let e=[];e=t.dependencies.map((e=>{const i=this.get_task(e);if(!i)return;const s=new c(this,this.bars[i._index],this.bars[t._index]);return this.layers.arrow.appendChild(s.element),s})).filter(Boolean),this.arrows=this.arrows.concat(e)}}map_arrows_on_bars(){for(let t of this.bars)t.arrows=this.arrows.filter((e=>e.from_task.task.id===t.task.id||e.to_task.task.id===t.task.id))}set_dimensions(){const{width:t}=this.$svg.getBoundingClientRect(),e=this.$svg.querySelector(".grid .grid-row")?this.$svg.querySelector(".grid .grid-row").getAttribute("width"):0;t<e&&this.$svg.setAttribute("width",e)}set_scroll_position(t){if(this.options.infinite_padding&&(!t||"start"===t)){let[t,...e]=this.get_start_end_positions();return void(this.$container.scrollLeft=t)}if(t&&"start"!==t)if("end"===t)t=this.gantt_end;else{if("today"===t)return this.scroll_current();"string"==typeof t&&(t=o.parse(t))}else t=this.gantt_start;const e=o.diff(t,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width;this.$container.scrollTo({left:e-this.config.column_width/6,behavior:"smooth"}),this.$current&&this.$current.classList.remove("current-upper"),this.current_date=o.add(this.gantt_start,this.$container.scrollLeft/this.config.column_width,this.config.unit);let i=this.config.view_mode.upper_text(this.current_date,null,this.options.language),s=this.upperTexts.find((t=>t.textContent===i));this.current_date=o.add(this.gantt_start,(this.$container.scrollLeft+s.clientWidth)/this.config.column_width,this.config.unit),i=this.config.view_mode.upper_text(this.current_date,null,this.options.language),s=this.upperTexts.find((t=>t.textContent===i)),s.classList.add("current-upper"),this.$current=s}scroll_current(){let t=this.get_closest_date();t&&this.set_scroll_position(t[0])}get_closest_date(){let t=new Date;if(t<this.gantt_start||t>this.gantt_end)return null;let e=new Date,i=this.$container.querySelector(".date_"+y(o.format(e,this.config.date_format,this.options.language))),s=0;for(;!i&&s<this.config.step;)e=o.add(e,-1,this.config.unit),i=this.$container.querySelector(".date_"+y(o.format(e,this.config.date_format,this.options.language))),s++;return[new Date(o.format(e,this.config.date_format,this.options.language)+" "),i]}bind_grid_click(){d.on(this.$container,"click",".grid-row, .grid-header, .ignored-bar, .holiday-highlight",(()=>{this.unselect_all(),this.hide_popup()}))}bind_holiday_labels(){const t=this.$container.querySelectorAll(".holiday-highlight");for(let e of t){const t=this.$container.querySelector(".label_"+e.classList[1]);if(!t)continue;let i;e.onmouseenter=e=>{i=setTimeout((()=>{t.classList.add("show"),t.style.left=(e.offsetX||e.layerX)+"px",t.style.top=(e.offsetY||e.layerY)+"px"}),300)},e.onmouseleave=e=>{clearTimeout(i),t.classList.remove("show")}}}get_start_end_positions(){if(!this.bars.length)return[0,0,0];let{x:t,width:e}=this.bars[0].group.getBBox(),i=t,s=t,n=t+e;return Array.prototype.forEach.call(this.bars,(function({group:t},e){let{x:a,width:r}=t.getBBox();a<i&&(i=a),a>s&&(s=a),a+r>n&&(n=a+r)})),[i,s,n]}bind_bar_events(){let t=!1,e=0,i=0,s=!1,n=!1,a=null,r=[];this.bar_being_dragged=null;this.$svg.onclick=t=>{t.target.classList.contains("grid-row")&&this.unselect_all()};let h=0;if(d.on(this.$svg,"mousemove",".bar-wrapper, .handle",(t=>{!1===this.bar_being_dragged&&Math.abs((t.offsetX||t.layerX)-h)>10&&(this.bar_being_dragged=!0)})),d.on(this.$svg,"mousedown",".bar-wrapper, .handle",((i,o)=>{const l=d.closest(".bar-wrapper",o);let g;o.classList.contains("left")?(s=!0,o.classList.add("visible")):o.classList.contains("right")?(n=!0,o.classList.add("visible")):o.classList.contains("bar-wrapper")&&(t=!0),this.popup&&this.popup.hide(),e=i.offsetX||i.layerX,i.offsetY||i.layerY,a=l.getAttribute("data-id"),g=this.options.move_dependencies?[a,...this.get_all_dependent_tasks(a)]:[a],r=g.map((t=>this.get_bar(t))),this.bar_being_dragged=!1,h=e,r.forEach((t=>{const e=t.$bar;e.ox=e.getX(),e.oy=e.getY(),e.owidth=e.getWidth(),e.finaldx=0}))})),this.options.infinite_padding){let t=!1;d.on(this.$container,"mousewheel",(e=>{let i=this.$container.scrollWidth/2;if(!t&&e.currentTarget.scrollLeft<=i){let i=e.currentTarget.scrollLeft;t=!0,this.gantt_start=o.add(this.gantt_start,-this.config.extend_by_units,this.config.unit),this.setup_date_values(),this.render(),e.currentTarget.scrollLeft=i+this.config.column_width*this.config.extend_by_units,setTimeout((()=>t=!1),300)}if(!t&&e.currentTarget.scrollWidth-(e.currentTarget.scrollLeft+e.currentTarget.clientWidth)<=i){let i=e.currentTarget.scrollLeft;t=!0,this.gantt_end=o.add(this.gantt_end,this.config.extend_by_units,this.config.unit),this.setup_date_values(),this.render(),e.currentTarget.scrollLeft=i,setTimeout((()=>t=!1),300)}}))}d.on(this.$container,"scroll",(t=>{let e=[];const s=this.bars.map((({group:t})=>t.getAttribute("data-id")));let n;i&&(n=t.currentTarget.scrollLeft-i),this.current_date=o.add(this.gantt_start,t.currentTarget.scrollLeft/this.config.column_width*this.config.step,this.config.unit);let a=this.config.view_mode.upper_text(this.current_date,null,this.options.language),r=this.upperTexts.find((t=>t.textContent===a));this.current_date=o.add(this.gantt_start,(t.currentTarget.scrollLeft+r.clientWidth)/this.config.column_width*this.config.step,this.config.unit),a=this.config.view_mode.upper_text(this.current_date,null,this.options.language),r=this.upperTexts.find((t=>t.textContent===a)),r!==this.$current&&(this.$current&&this.$current.classList.remove("current-upper"),r.classList.add("current-upper"),this.$current=r),i=t.currentTarget.scrollLeft;let[h,d,l]=this.get_start_end_positions();i>l+100?(this.$adjust.innerHTML="&larr;",this.$adjust.classList.remove("hide"),this.$adjust.onclick=()=>{this.$container.scrollTo({left:d,behavior:"smooth"})}):i+t.currentTarget.offsetWidth<h-100?(this.$adjust.innerHTML="&rarr;",this.$adjust.classList.remove("hide"),this.$adjust.onclick=()=>{this.$container.scrollTo({left:h,behavior:"smooth"})}):this.$adjust.classList.add("hide"),n&&(e=s.map((t=>this.get_bar(t))),this.options.auto_move_label&&e.forEach((e=>{e.update_label_position_on_horizontal_scroll({x:n,sx:t.currentTarget.scrollLeft})})))})),d.on(this.$svg,"mousemove",(i=>{if(!(t||s||n))return;const o=(i.offsetX||i.layerX)-e;r.forEach((e=>{const i=e.$bar;i.finaldx=this.get_snap_position(o,i.ox),this.hide_popup(),s?a===e.task.id?e.update_bar_position({x:i.ox+i.finaldx,width:i.owidth-i.finaldx}):e.update_bar_position({x:i.ox+i.finaldx}):n?a===e.task.id&&e.update_bar_position({width:i.owidth+i.finaldx}):t&&!this.options.readonly&&!this.options.readonly_dates&&e.update_bar_position({x:i.ox+i.finaldx})}))})),document.addEventListener("mouseup",(()=>{var e,i,a;t=!1,s=!1,n=!1,null==(a=null==(i=null==(e=this.$container.querySelector(".visible"))?void 0:e.classList)?void 0:i.remove)||a.call(i,"visible")})),d.on(this.$svg,"mouseup",(t=>{this.bar_being_dragged=null,r.forEach((t=>{t.$bar.finaldx&&(t.date_changed(),t.compute_progress(),t.set_action_completed())}))})),this.bind_bar_progress()}bind_bar_progress(){let t=0,e=null,i=null,s=null,n=null;d.on(this.$svg,"mousedown",".handle.progress",((a,r)=>{e=!0,t=a.offsetX||a.layerX,y_on_start=a.offsetY||a.layerY;const o=d.closest(".bar-wrapper",r).getAttribute("data-id");i=this.get_bar(o),s=i.$bar_progress,n=i.$bar,s.finaldx=0,s.owidth=s.getWidth(),s.min_dx=-s.owidth,s.max_dx=n.getWidth()-s.getWidth()}));const a=this.config.ignored_positions.map((t=>[t,t+this.config.column_width]));d.on(this.$svg,"mousemove",(n=>{if(!e)return;let r=n.offsetX||n.layerX;if(r>t){let t=a.find((([t,e])=>r>=t&&r<e));for(;t;)r=t[1],t=a.find((([t,e])=>r>=t&&r<e))}else{let t=a.find((([t,e])=>r>t&&r<=e));for(;t;)r=t[0],t=a.find((([t,e])=>r>t&&r<=e))}let o=r-t;o>s.max_dx&&(o=s.max_dx),o<s.min_dx&&(o=s.min_dx),s.setAttribute("width",s.owidth+o),d.attr(i.$handle_progress,"cx",s.getEndX()),s.finaldx=o})),d.on(this.$svg,"mouseup",(()=>{e=!1,s&&s.finaldx&&(s.finaldx=0,i.progress_changed(),i.set_action_completed(),i=null,s=null,n=null)}))}get_all_dependent_tasks(t){let e=[],i=[t];for(;i.length;){const t=i.reduce(((t,e)=>t=t.concat(this.dependency_map[e])),[]);e=e.concat(t),i=t.filter((t=>!i.includes(t)))}return e.filter(Boolean)}get_snap_position(t,e){let i=1;const s=this.options.snap_at||this.config.view_mode.snap_at||"1d";if("unit"!==s){const{duration:t,scale:e}=o.parse_duration(s);i=o.convert_scales(this.config.view_mode.step,e)/t}const n=t%(this.config.column_width/i);let a=t-n+(n<this.config.column_width/i*2?0:this.config.column_width/i),r=e+a;const h=a>0?1:-1;let d=this.get_ignored_region(r,h);for(;d.length;)r+=this.config.column_width*h,d=this.get_ignored_region(r,h),d.length||(r-=this.config.column_width*h);return r-e}get_ignored_region(t,e=1){return 1===e?this.config.ignored_positions.filter((e=>t>e&&t<=e+this.config.column_width)):this.config.ignored_positions.filter((e=>t>=e&&t<e+this.config.column_width))}unselect_all(){this.popup&&this.popup.parent.classList.add("hide"),this.$container.querySelectorAll(".date-range-highlight").forEach((t=>t.classList.add("hide")))}view_is(t){return"string"==typeof t?this.config.view_mode.name===t:Array.isArray(t)?t.some(view_is):this.config.view_mode.name===t.name}get_task(t){return this.tasks.find((e=>e.id===t))}get_bar(t){return this.bars.find((e=>e.task.id===t))}show_popup(t){!1!==this.options.popup&&(this.popup||(this.popup=new u(this.$popup_wrapper,this.options.popup,this)),this.popup.show(t))}hide_popup(){this.popup&&this.popup.hide()}trigger_event(t,e){this.options["on_"+t]&&this.options["on_"+t].apply(this,e)}get_oldest_starting_date(){return this.tasks.length?this.tasks.map((t=>t._start)).reduce(((t,e)=>e<=t?e:t)):new Date}clear(){var t,e,i,s,n,a,r,o,h,d;this.$svg.innerHTML="",null==(e=null==(t=this.$header)?void 0:t.remove)||e.call(t),null==(s=null==(i=this.$side_header)?void 0:i.remove)||s.call(i),null==(a=null==(n=this.$current_highlight)?void 0:n.remove)||a.call(n),null==(o=null==(r=this.$extras)?void 0:r.remove)||o.call(r),null==(d=null==(h=this.popup)?void 0:h.hide)||d.call(h)}}function y(t){return t.replaceAll(" ","_").replaceAll(":","_").replaceAll(".","_")}w.VIEW_MODE={DAY:m[3],WEEK:m[4],MONTH:m[5],YEAR:m[6]};export{w as default};
//# sourceMappingURL=frappe-gantt.min.js.map
